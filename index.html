<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Speed Pro Max | 輕量優化版</title>
    <style>
        :root { --bg: #060910; --card: #111827; --primary: #0ea5e9; --accent: #22c55e; --text: #f8fafc; --dim: #64748b; }
        body { background: var(--bg); color: var(--text); font-family: system-ui, sans-serif; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; box-sizing: border-box; }
        .box { width: 100%; max-width: 400px; text-align: center; background: var(--card); padding: 30px; border-radius: 28px; border: 1px solid #1f2937; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .num { font-size: 4.5rem; font-weight: 900; display: block; margin: 10px 0; color: var(--primary); letter-spacing: -2px; }
        .btn { width: 100%; padding: 16px; border-radius: 50px; border: none; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 20px; background: var(--primary); color: white; }
        .btn:disabled { opacity: 0.4; filter: grayscale(1); }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 25px; }
        .stat { background: rgba(255,255,255,0.03); padding: 12px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); }
        .label { font-size: 0.7rem; color: var(--dim); text-transform: uppercase; margin-bottom: 4px; }
        .val { font-size: 1rem; font-weight: bold; }
    </style>
</head>
<body>
<div class="box">
    <div style="color:var(--dim); font-size: 0.7rem; font-weight: bold; letter-spacing: 2px;">MOBILE OPTIMIZED</div>
    <span id="speed" class="num">0.0</span>
    <div id="status" style="color:var(--dim); font-size: 0.9rem; margin-bottom: 20px;">Ready to Test</div>
    <div class="grid">
        <div class="stat"><div class="label">Ping</div><div class="val" id="p">--</div></div>
        <div class="stat"><div class="label">Jitter</div><div class="val" id="j">--</div></div>
        <div class="stat"><div class="label">Upload</div><div class="val" id="u">--</div></div>
        <div class="stat"><div class="label">Peak</div><div class="val" id="peak">--</div></div>
    </div>
    <button id="go" class="btn" onclick="run()">START TEST</button>
</div>
<script>
    const data = { down: 0, up: 0, ping: 0, jitter: 0, peak: 0 };
    async function run() {
        const btn = document.getElementById('go'); const status = document.getElementById('status');
        btn.disabled = true; data.peak = 0;
        try {
            // 1. Ping 測試 (加入 Timeout 防止卡死)
            status.innerText = "正在探測連線...";
            const pings = [];
            for(let i=0; i<3; i++) { // 減少到 3 次提高速度
                const s = performance.now();
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), 2000); // 2秒沒反應就放棄
                try {
                    await fetch('https://speed.cloudflare.com/cdn-cgi/trace', { signal: controller.signal, cache: 'no-store' });
                    pings.push(performance.now() - s);
                } catch(e) {}
                clearTimeout(id);
            }
            data.ping = pings.length ? Math.round(pings.reduce((a,b)=>a+b)/pings.length) : 'Timeout';
            document.getElementById('p').innerText = data.ping + (pings.length ? ' ms' : '');
            
            // 2. 下載測試 (縮減至 10MB)
            status.innerText = "測試下載速度 (10MB)...";
            const dRes = await fetch('https://speed.cloudflare.com/__down?bytes=10000000', { cache: 'no-store' });
            const reader = dRes.body.getReader();
            let bytes = 0; const dStart = performance.now();
            while(true) {
                const {done, value} = await reader.read(); if(done) break; bytes += value.length;
                const sec = (performance.now() - dStart) / 1000;
                if(sec > 0.1) {
                    data.down = (bytes * 8 / 1000000) / sec;
                    document.getElementById('speed').innerText = data.down.toFixed(1);
                    if(data.down > data.peak) data.peak = data.down;
                    document.getElementById('peak').innerText = data.peak.toFixed(1);
                }
            }
            // 3. 上傳測試
            status.innerText = "測試上傳速度...";
            const uStart = performance.now();
            await fetch('https://speed.cloudflare.com/__up', { method: 'POST', body: new Uint8Array(2*1024*1024) });
            data.up = (2 * 8 * 1024 * 1024 / 1000000) / ((performance.now() - uStart)/1000);
            document.getElementById('u').innerText = data.up.toFixed(1) + ' Mbps';
            status.innerText = "測試完成";
            if(navigator.vibrate) navigator.vibrate(200);
        } catch(e) { status.innerText = "連線不穩定"; }
        btn.disabled = false; btn.innerText = 'RESTART';
    }
</script>
</body>
</html>
